---
description: Frontend flutter guidelines
alwaysApply: false
---
# Flutter App Development Guidelines

## App Structure
- State management: 7 providers (PregnancyProvider, ChatProvider, ChatSessionProvider, TrackerProvider, UserProfileProvider, HomeProvider, AuthProvider)
- Key screens: HomeScreen (dashboard), ChatbotScreen, TrackerScreen, CalendarScreen, UserProfileScreen, LoginScreen
- UI: Material Design 3 with pregnancy-themed color palette, responsive design
- Authentication: Custom session token system with Firebase Auth for identity verification
- Models: Pregnancy, PregnancyTip, PregnancyMilestone, DailyChecklist, WeeklyContent, UserProfile, Symptom, Appointment, WeightEntry

## Common Commands
- Flutter: `flutter pub get`, `flutter run`, `flutter build apk`

## UI/UX Guidelines
- Use pregnancy-themed color palette (soft pastels)
- Implement Material Design 3 with smooth animations
- Ensure responsive design for different screen sizes
- Include accessibility features for inclusive design
- Maintain consistent pregnancy-focused user experience

## State Management
- Use Provider pattern for all state management
- Implement proper error handling and loading states
- **HomeProvider**: Separate loading states for tips, milestones, and checklist components
- **Loading State Management**: Set `isLoading = false` when data loads successfully or fails, especially for empty states (e.g., no pregnancy data)
- Optimize for performance with appropriate widget rebuilding
- Handle offline scenarios gracefully

## Pregnancy-Specific Features
- Accurate pregnancy calculations and timeline display
- Visual progress indicators with trimester-specific colors
- Context-aware AI responses based on current pregnancy week
- Health tracking with appropriate medical disclaimers
- **Weekly Content Display**: "This Week" section shows milestones when available, or AI-generated weekly content (highlights, facts, things to do) when no milestones exist
- **Home Screen Sections**: Today's Focus (tips carousel), This Week (milestones/weekly content), Daily Checklist (personalized tasks)

## Authentication & User Management
- **Custom Session Token System**: Uses custom JWT session tokens (not Firebase tokens) for API authentication
- **Firebase Auth**: Used only for initial Google Sign-In and identity verification
- **Session Token Storage**: Session and refresh tokens stored in SharedPreferences
- **AuthenticatedHttpClient**: Custom HTTP client that automatically adds session tokens to all API requests
- **Automatic Token Refresh**: Reactive token refresh on expiration or 401 errors
- **401 Error Handling**: Automatic logout on session revocation or expiration
- **Session Management**: Calls `/api/auth/login` after Firebase sign-in to obtain session tokens
- **Logout Flow**: Backend logout endpoint called before clearing local tokens and Firebase sign-out
- **Token Expiration**: Checks token expiration before making API calls
- **Race Condition Prevention**: Uses `_isLoggingOut` flag and `Completer` to prevent concurrent login/logout
- Logout functionality with confirmation dialogs
- User profile synchronization with backend
- Multi-user support with user-specific data isolation

## Error Handling & User Experience
- Comprehensive error handling with user-friendly messages
- **401 Unauthorized Handling**: Automatic token refresh on 401 errors
- **Session Revocation Detection**: Immediate logout when session is revoked or expired
- **API Call Retry**: Automatic retry after successful token refresh
- Loading states and skeleton loaders for better UX
- Optimistic UI updates with rollback on API failures
- Retry mechanisms for failed API calls
- Graceful degradation when services are unavailable