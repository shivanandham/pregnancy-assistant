---
description: "Backend development guidelines and API structure"
alwaysApply: false
---
# Backend Development Guidelines

## API Structure
- Express.js backend with Prisma ORM
- Main endpoints: /api/chat, /api/pregnancy, /api/symptoms, /api/appointments, /api/weight, /api/home
- Auth endpoints: /api/auth/login, /api/auth/refresh, /api/auth/logout, /api/auth/logout-all
- Security: Helmet.js, CORS, rate limiting, input validation with Joi
- AI integration: Google Gemini API with pregnancy-specific context and medical disclaimers

## Database Schema (Prisma)
- User: Firebase user integration with authentication data
- UserProfile: User demographics and medical information
- Session: Custom session token management (JWT tokens, refresh tokens, expiration tracking)
- PregnancyData: Due date, LMP, and pregnancy timeline
- ChatSession/ChatMessage: AI conversation management with diagnostic support
- Symptom/Appointment/WeightEntry: Health tracking data
- KnowledgeFact/ConversationChunk: Extracted knowledge and searchable conversations
- PregnancyTip: Weekly tips with expiration dates (cached for 7 days)
- DailyChecklistItem: User-specific daily checklist items (cached per day until midnight)
- WeeklyContent: Week-specific content with highlights, facts, and things to do (cached per user per week)
- ChecklistCompletion: Daily task completion tracking

## Environment Configuration
- **Development**: Local laptop (NODE_ENV=development)
- **Production**: DigitalOcean droplet (NODE_ENV=production)
- **Development Database**: Local PostgreSQL on laptop
- **Production Database**: PostgreSQL on DigitalOcean droplet
- **AI**: Google Gemini API key required
- **Authentication**: Firebase Auth with Google Sign-In (identity verification only)
- **Session Management**: Custom JWT session tokens with refresh tokens
- **JWT Configuration**: JWT_SECRET, JWT_EXPIRES_IN (default: 30d), JWT_REFRESH_EXPIRES_IN (default: 90d)

## Common Commands
- Backend: `npm run dev` (development), `npm run deploy:db` (database)
- Database: `npm run db:studio` (Prisma Studio)

## AI Services Guidelines
- Always include medical disclaimers in AI responses
- Use pregnancy-specific context with current week information
- Implement diagnostic questioning for symptom assessment
- Extract and store knowledge from conversations for future reference
- Generate personalized content using Gemini 2.5 Flash for tips, checklists, and weekly content
- Cache AI-generated content to reduce API calls and costs (tips: 7 days, checklists: daily, weekly content: per week)

## Content Caching Strategy
- **Pregnancy Tips**: Cached per week, expires after 7 days. Uses `PregnancyTip.getTipsForWeek()` which checks for existing tips before generating.
- **Daily Checklist**: Cached per user per day, expires at midnight. Uses `DailyChecklist.generateDynamicChecklist()` which checks for existing items before generating.
- **Weekly Content**: Cached per user per week, expires after 7 days. Uses `WeeklyContent.getContentForWeek()` which generates highlights, facts, and things to do using Gemini.
- **Caching Logic**: All cached content checks expiration before returning, regenerates only when expired or missing

## Authentication & Security
- **Custom Session Token System**: Separates Firebase identity from session management
- **Firebase Auth**: Used only for initial identity verification during login
- **Session Tokens**: JWT-based custom session tokens for API authentication
- **Refresh Tokens**: Long-lived tokens for obtaining new session tokens without re-authentication
- **Session Service**: `backend/services/sessionService.js` handles token generation, verification, refresh, and revocation
- **Token Validation**: All protected endpoints use session token middleware (not Firebase tokens)
- **Session Control**: Immediate revocation via database check on each request
- **One Session Per User**: New login revokes all existing sessions for the user
- **Automatic Cleanup**: Cron job removes expired and revoked sessions
- **Security Features**: Token rotation on refresh, device info tracking, expiration management
- Multi-user support with user-specific data isolation

## Database Configuration
- **Development Database**: Local PostgreSQL on laptop
- **Production Database**: PostgreSQL on DigitalOcean droplet
- **Database URL**: Configured via environment variables based on NODE_ENV
- **Connection**: Automatic selection based on NODE_ENV
- **Connection pooling**: Graceful shutdown handling
- **Migrations**: Prisma migrations for all schema changes (must be in sync between environments)

## Database Migration Rules ⚠️ CRITICAL
**ALL schema changes MUST go through Prisma migrations. Direct database modifications are STRICTLY PROHIBITED.**

### Required Migration Workflow
1. **In Development** (local laptop):
   - Modify `prisma/schema.prisma` with schema changes
   - Generate and apply migration: `npx prisma migrate dev --name <descriptive-name>`
     - This generates the migration file and applies it to your local database
   - Carefully review generated migration SQL file in `prisma/migrations/`
   - Commit both `schema.prisma` and migration files together

2. **In Production** (droplet):
   - Pull latest code with migrations
   - Create database backup before applying migrations
   - Apply existing migrations: `npx prisma migrate deploy`
     - This applies migrations to the production database on droplet
   - Verify migration status: `npx prisma migrate status`

### ✅ DO's
- ✅ Use migrations for ALL schema changes (tables, columns, indexes, constraints, foreign keys)
- ✅ Use descriptive migration names (e.g., `add_user_email_verification`)
- ✅ Review generated migration SQL carefully before committing
- ✅ Create database backups before major schema changes
- ✅ Commit both `schema.prisma` and migration files together

### ❌ DON'Ts
- ❌ NEVER modify database schema directly via SQL (CREATE TABLE, ALTER TABLE, DROP TABLE, etc.)
- ❌ NEVER use direct database modifications via psql, pgAdmin, or other tools
- ❌ NEVER edit migration files after they've been committed
- ❌ NEVER skip or revert migrations
- ❌ NEVER use `prisma db push` (always use migrations)
- ❌ NEVER drop or recreate the database (data loss risk)
- ❌ NEVER apply migrations without reviewing the generated SQL first

### Migration Commands
- **Development** (local laptop): `npx prisma migrate dev --name <name>` (create and apply)
- **Production** (droplet): `npx prisma migrate deploy` (apply existing migrations)
- Check status: `npx prisma migrate status`
- Generate client: `npx prisma generate`

See `backend/prisma/MIGRATION_RULES.md` for complete migration guidelines.